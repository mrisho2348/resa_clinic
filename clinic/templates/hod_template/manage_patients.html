{% extends 'hod_template/base_template.html' %}
{% block title %}
   List of all patients    
{% endblock title %}

{% block page_title %}
   List of all patients    
{% endblock page_title %}

{% block breadcrumb %}
{% include "hod_template/modal_form.html" %}
    <a class="btn btn-primary float-right" type="button" data-toggle="modal" data-target="#registerModal">
        <i class="fas fa-plus"></i> New patients
    </a>
    <a class="btn btn-success float-right mr-2" href="{% url 'import_patient_records' %}">
        <i class="fas fa-file-import"></i> Import patients
      </a>
{% endblock breadcrumb %}
{% block main_content %}


    <table class="table table-hover text-nowrap table-bordered table-striped table-sm" id="example">
        <thead>
            <tr>
                <th>#</th>
                <th>mrn</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Payment form</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patient_records %}
                <tr>
                    <td>{{ patient.id }}</td>
                    <td>{{ patient.mrn }}</td>
                    <td>{{ patient.fullname }}</td>
                    <td>      <script>
                        var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                        var now = new Date();
                        var ageMilliseconds = now - dob;
                        var ageSeconds = ageMilliseconds / 1000;
                        var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                        document.write(ageYears + ' years');
                    </script>
                </td>
                    <td>{{ patient.gender }}</td>
                    <!-- Add more cells for other fields -->
                    <td>{{ patient.payment_form }}</td>
                    <td>{{ patient.phone }}</td>
                    <td>{{ patient.email }}</td>                   
                    <td>
                        <a href="{% url 'edit_patient' patient.id %}"  data-toggle="tooltip" title="edit" > 
                            <button type="button" class="btn btn-dark btn-sm"><i class="fa fa-edit text-white"></i></button>
                        </a>
                        <a href="{% url 'delete_patient' patient.id %}"  data-toggle="tooltip" title="Delete"> 
                            <button type="button" class="btn btn-danger btn-sm">  <i class="fas fa-trash"></i></button>
                        </a>
                        <!-- Add more action links as needed -->
                        <a href="{% url 'view_patient' patient.id %}"  data-toggle="tooltip" title="View detail">
                             <button type="button" class="btn btn-primary border btn-sm"><i class="fa fa-eye text-dark"></i></button>
                        </a>
                    <!-- Appointment Action -->
                        <a href="{% url 'appointment_view' patient.id %}" >
                            <button type="button" class="btn btn-light border btn-sm">
                                <i class="fas fa-calendar text-dark" title="Appointment"></i>
                            </button>
                        </a>

                        <!-- Visit Action -->
                        <button type="button" class="btn btn-light border btn-sm" data-toggle="modal" data-target="#addVisitModal{{ patient.id }}" title="Add Visit">
                            <i class="fas fa-eye text-dark"></i>
                          </button>
                                 <!-- Add more action links as needed -->
                        <a href="{% url 'patient_visit_history_view' patient.id %}" data-toggle="tooltip" title="open visit History">
                        <button type="button" class="btn btn-primary btn-sm"><i class="fa fa-eye text-dark"></i></button>
                    </a>   
                        <a href="{% url 'patient_visit_history_view' patient.id %}" data-toggle="tooltip" title="open visit History">
                        <button type="button" class="btn btn-primary btn-sm"><i class="fa fa-eye text-dark"></i></button>
                    </a>   
                    </td>


                    <!-- Bootstrap Modal for Adding Visit -->
                    <div class="modal fade" id="addVisitModal{{ patient.id }}" tabindex="-1" aria-labelledby="addVisitModalLabel{{ patient.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-teal-800">
                                    <h3 class="modal-title text-center text-uppercase">Add Visit for {{ patient.fullname }}</h3>
                                    <button type="button" class="close" data-dismiss="modal">Ã—</button>
                                </div>
                    
                                <div class="modal-body">
                                    <!-- Form for adding a visit -->
                                    <form id="addVisitForm{{ patient.id }}" method="post">
                                        {% csrf_token %}
                                        <!-- Visit type dropdown -->
                                        <div class="form-group">
                                            <label for="visitType">Visit Type:</label>
                                            <select class="form-control select2bs4" style="width: 100%;" id="visitType{{ patient.id }}" name="visitType">
                                                <option value="Normal">Normal</option>
                                                <option value="Emergency">Emergency</option>
                                                <option value="Referral">Referral</option>
                                                <option value="Follow-up">Follow-up</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">Primary Service:</label>
                                            <select class="form-control select2bs4" style="width: 100%;" id="primary_service{{ patient.id }}" name="primary_service">
                                                <option value="Consultation">Consultation</option>
                                                <option value="Imaging">Imaging</option>
                                                <option value="Investigation">Investigation</option>
                                                <option value="Procedure">Procedure</option>
                                                <option value="Physiotherapy">Physiotherapy</option>
                                                <option value="Ambulance">Ambulance</option>
                                            </select>
                                        </div>
                                        <!-- Additional fields for insurance payment -->
                                        <div class="form-group" id="insuranceFields{{ patient.id }}" style="display: none;">
                                            <label class="control-label">Insurance Name:</label>
                                            <input type="text" class="form-control" id="insuranceName{{ patient.id }}" name="insuranceName" value="{{ patient.insurance_name }}" readonly>
                                            <label class="control-label">Insurance Number:</label>
                                            <input type="text" class="form-control" id="insuranceNumber{{ patient.id }}" name="insuranceNumber" value="{{ patient.insurance_number }}" readonly>
                                            <label class="control-label">Verification Code:</label>
                                            <input type="text" class="form-control" id="verificationCode{{ patient.id }}" name="verificationCode">
                                        </div>
                                        <!-- Visit reason field -->
                                        <div class="form-group" id="visitReason{{ patient.id }}" style="display: none;">
                                            <label class="control-label">Visit Reason:</label>
                                            <textarea class="form-control" id="visitReasonText{{ patient.id }}" name="visitReason"></textarea>
                                        </div>
                                        <!-- Referral number field -->
                                        <div class="form-group" id="referralNumber{{ patient.id }}" style="display: none;">
                                            <label class="control-label">Referral Number:</label>
                                            <input type="text" class="form-control" id="referralNumberText{{ patient.id }}" name="referralNumber">
                                            <input type="hidden" class="form-control" id="patient_id{{ patient.id }}" name="patient_id" value="{{ patient.id }}">
                                            <input type="hidden" class="form-control" id="visit_id{{ patient.id }}" name="visit_id">
                                        </div>
                    
                                        <div class="form-group pt-2 float-end">
                                            <div class="row">
                                                <div class="col-md-8"></div>
                                                <div class="col-md-4">
                                                    <button type="button" class="btn btn-md btn-primary"  onclick="AddVisit({{ patient.id }})">Save and Continue <i class="mdi mdi-forward"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                       
                    <script>
                        function AddVisit(patientId) {
                            var visitType = $('#visitType' + patientId).val();
                            var primary_service = $('#primary_service' + patientId).val();
                            var insuranceName = $('#insuranceName' + patientId).val();
                            var insuranceNumber = $('#insuranceNumber' + patientId).val();
                            var verificationCode = $('#verificationCode' + patientId).val();
                            var visitReason = $('#visitReason' + patientId).val();
                            var referralNumber = $('#referralNumber' + patientId).val();
                            var patient_id = $('#patient_id' + patientId).val();
                            var visit_id = $('#visit_id' + patientId).val();
                         
                       
                            $.ajax({
                                type: 'POST',
                                url: '/add_patient_visit/',
                                data: {                
                                    visitType: visitType,                              
                                    insuranceName: insuranceName,
                                    insuranceNumber: insuranceNumber,
                                    verificationCode: verificationCode,
                                    visitReason: visitReason,
                                    referralNumber: referralNumber,
                                    patient_id: patient_id,
                                    visit_id: visit_id,
                                    primary_service: primary_service
                                },
                                success: function(data) {
                                    if (data.status === 'success') {
                                        // Display success message                    
                                        $('#addVisitModal' + patientId).modal('hide');
                                        location.reload(true);
                                    } 
                                    else {
                                        // Display error message if any
                                        alert(data.message);
                                    }
                                    // Hide the modal after displaying the message
                                  
                                },
                                error: function(error) {
                                    alert(error);
                                    // Display error message
                                    $('#successMessageContainer').html('<div class="alert alert-danger" role="alert">Failed to use item</div>');
                                    // Hide the modal after displaying the message
                                 
                                }
                            });
                        }
                    </script>
                    
                    <script>
                        $(document).ready(function () {
                            // Show/hide additional fields based on visit type
                            $('#visitType{{ patient.id }}').change(function () {
                                var visitType = $(this).val();
                                if (visitType == 'Emergency') {
                                    $('#visitReason{{ patient.id }}').show();
                                    $('#referralNumber{{ patient.id }}').hide();
                                } else if (visitType == 'Referral') {
                                    $('#visitReason{{ patient.id }}').hide();
                                    $('#referralNumber{{ patient.id }}').show();
                                } else {
                                    $('#visitReason{{ patient.id }}').hide();
                                    $('#referralNumber{{ patient.id }}').hide();
                                }
                            });
                    
                            // Show insurance fields if payment method is insurance
                            var paymentForm = "{{ patient.payment_form }}";
                            if (paymentForm == 'insurance') {
                                $('#insuranceFields{{ patient.id }}').show();
                            }
                        });
                    </script>
                    
  
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

   


    <script>
        function submitForm(checkbox) {
            checkbox.form.submit();
        }
    </script>

{% include 'hod_template/datatable.html' %}
    

{% endblock main_content %}
