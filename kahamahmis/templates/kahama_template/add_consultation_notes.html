{% extends 'kahama_template/base_template.html' %}

{% block title %}
{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Consultation notes
{% endblock title %}

{% block breadcrumb %}
{% include "kahama_template/modal_form.html" %}
Add  Consultation notes
{% endblock breadcrumb %}

{% block main_content %}
    <div class="container">
           <!-- Patient Information Card -->
           <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary-600">
                        <h5 class="card-title text-center text-uppercase">Consultation</h5>
                    </div>
                    <div class="card-body">
                            <div class="card">
                                <div class="card-header">
                                    <label for="chief_complaints">Patient information</label>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            PATIENT: <b>{{ patient.first_name }} {{ patient.middle_name }}  {{ patient.last_name }}</b>
                                        </div>
                                        <div class="col-md-3">DOB: <b>{{ patient.dob|date:'Y-m-d' }} [ Age: {% if patient.dob %}
                                            <script>
                                                var dob = new Date("{{ patient.dob|date:'Y-m-d' }}");
                                                var now = new Date();
                                                var ageMilliseconds = now - dob;
                                                var ageSeconds = ageMilliseconds / 1000;
                                                var ageYears = Math.floor(ageSeconds / (365.25 * 24 * 60 * 60));
                                                document.write(ageYears + ' years');
                                            </script>
                                            {% else %}
                                            {{ patient.age }}
                                            {% endif %}]</b></div>
                                        <div class="col-md-3">
                                            SEX: <b>{{ patient.gender }}</b>
                                        </div>
                                        <div class="col-md-3">
                                            FILE NO: <b>{{ patient.mrn }}</b>
                                        </div>
                                    </div>
                                    <br />
                                    <div class="row">
                                        <div class="col-md-3">
                                            company: <b>{{ patient.company }}</b>
                                        </div>                           
                                            <div class="col-md-3">Visit  number: <b>{{ visit.vst }}</b>
                                            </div>                                      
                                    </div>
                                </div>
                            </div>
                        </div>
                   </div>
            </div> 
        </div>              
                        <br />
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <label for="chief_complaints">Vital signs</label>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>                                          
                                                        <th>Time</th>
                                                        <th>BP</th>
                                                        <th>HR</th>
                                                        <th>RR</th>
                                                        <th>SPO2</th>                                         
                                                        <th>TEMP</th>
                                                        <th>GCS</th>
                                                        <th>AVPU</th>
                                                        <th></th>
                                                 </tr>
                                                </thead>
                                                <tbody>
                                                    {% for vital in patient_vitals %}
                                                        <tr>
                                                        <td>{{ vital.updated_at|time:"H:i:s" }}</td>
                                                        <td>{{ vital.blood_pressure }}</td>
                                                        <td>{{ vital.pulse_rate }}</td>
                                                        <td>{{ vital.respiratory_rate }}</td>
                                                        <td>{{ vital.spo2 }}</td>                                            
                                                        <td>{{ vital.temperature }}</td>
                                                        <td>{{ vital.gcs }}</td>
                                                        <td>{{ vital.avpu }}</td>
                                                        <td>
                                                            <a href="#" class="btn btn-info btn-xs btn-labeled" type="button" data-toggle="modal" data-target="#editPatientVitalModal{{ vital.id }}"><b><i class="icon-pencil"></i></b> Edit</a>
                                                        </td>
                                                    </tr>
                                                    <div class="modal fade" id="editPatientVitalModal{{ vital.id }}" tabindex="-1" aria-labelledby="patientVitalModalLabel{{ vital.id }}" aria-hidden="true">
                                                        <div class="modal-dialog modal-lg">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="editPatientVitalModalLabel{{ vital.id }}">Edit Patient Vital</h5>
                                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                        <span aria-hidden="true">&times;</span>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form id="editPatientVitalForm{{ vital.id }}" method="post">
                                                                        <!-- Patient ID (hidden input) -->
                                                                        <input type="hidden" name="patient_id" id="edit_patient_id" value="{{ patient.id }}">
                                                                        <input type="hidden" name="vital_id" id="edit_vital_id" value="{{ vital.id }}">
                                                                        <input type="hidden" class="form-control" id="visit_id" name="visit_id" value="{{ visit.id }}">
                                                                        
                                                                        <div class="row">
                                                                            <!-- Column 1 -->
                                                                            <div class="col-md-4">
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_respiratoryRate{{ vital.id }}" class="form-label">Respiratory Rate (bpm)</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_respiratoryRate{{ vital.id }}" name="respiratory_rate">
                                                                                        {% for rate in range_51 %}
                                                                                            <option value="{{ rate }}" {% if rate == vital.respiratory_rate %} selected {% endif %}>{{ rate }}</option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_pulseRate{{ vital.id }}" class="form-label">Pulse Rate (bpm)</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_pulseRate{{ vital.id }}" name="pulse_rate">
                                                                                        {% for rate in range_301 %}
                                                                                            <option value="{{ rate }}" {% if rate == vital.pulse_rate %} selected {% endif %}>{{ rate }}</option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                            <!-- Column 2 -->
                                                                            <div class="col-md-4">
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_bloodPressure{{ vital.id }}" class="form-label">Blood Pressure</label>
                                                                                    <input type="text" class="form-control" id="edit_bloodPressure{{ vital.id }}" name="blood_pressure" value="{{ vital.blood_pressure }}">
                                                                                </div>
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_spo2{{ vital.id }}" class="form-label">SPO2 (%)</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_spo2{{ vital.id }}" name="spo2">
                                                                                        {% for percentage in range_101 %}
                                                                                            <option value="{{ percentage }}" {% if percentage == vital.spo2 %} selected {% endif %}>{{ percentage }}%</option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                            <!-- Column 3 -->
                                                                            <div class="col-md-4">
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_temperature{{ vital.id }}" class="form-label">Temperature (Â°C)</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_temperature{{ vital.id }}" name="temperature">
                                                                                        {% for temp in temps %}
                                                                                            <option value="{{ temp }}" {% if temp == vital.temperature %} selected {% endif %}>{{ temp }}</option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_gcs{{ vital.id }}" class="form-label">Glasgow Coma Scale</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_gcs{{ vital.id }}" name="gcs">
                                                                                        {% for score in range_15 %}
                                                                                            <option value="{{ score }}" {% if score == vital.gcs %} selected {% endif %}>{{ score }}</option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                                <div class="mb-3 form-group">
                                                                                    <label for="edit_avpu{{ vital.id }}" class="form-label">AVPU Scale</label>
                                                                                    <select class="form-control select2bs4" style="width: 100%;" id="edit_avpu{{ vital.id }}" name="avpu">
                                                                                        <option value="Alert" {% if vital.avpu == 'Alert' %} selected {% endif %}>Alert</option>
                                                                                        <option value="Verbal" {% if vital.avpu == 'Verbal' %} selected {% endif %}>Verbal</option>
                                                                                        <option value="Pain" {% if vital.avpu == 'Pain' %} selected {% endif %}>Pain</option>
                                                                                        <option value="Unresponsive" {% if vital.avpu == 'Unresponsive' %} selected {% endif %}>Unresponsive</option>
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="form-row">
                                                                            <div class="col-md-12">
                                                                                <button type="button" class="btn btn-primary btn-block" onclick="updateRemotePatientVital({{ vital.id }})">Update Patient Vital</button>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <script>
                                                        // Handle form submission using AJAX
                                                        function updateRemotePatientVital(vitalId) {
                                                            $.ajax({
                                                                type: 'POST',
                                                                url: '{% url "kahamahmis:save_remotepatient_vital" %}',  // Replace with your URL
                                                                data: $('#editPatientVitalForm' + vitalId).serialize(),
                                                                success: function (data) {
                                                                    if (data.status === 'success') {
                                                                        $('#editPatientVitalModal' + vitalId).modal('hide');
                                                                        location.reload(true);
                                                                        // Refresh the inventory vital list or perform any other actions
                                                                    } else {
                                                                        // Handle other status cases if needed
                                                                        alert(data.message);
                                                                    }
                                                                },
                                                                error: function (error) {
                                                                    alert(error);
                                                                    // Handle errors if necessary
                                                                }
                                                            });
                                                        }
                                                    </script>
                                                    {% endfor %}
                                                 
                                                </tbody>
                                            </table>
                                            <div class="row">
                                                <div class="col-md-10"></div>
                                                <div class="col-md-2"><a href="#" class="btn btn-info btn-xs btn-labeled" type="button" data-toggle="modal" data-target="#addPatientVitalModal"><b><i class="fa fa-plus-square"></i></b> Add New vital</a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md">
                                <div class="card">
                                    <div class="card-header">
                                         <label for="chief_complaints">Chief Complaints</label>
                                    </div>
                                    <div class="card-body">
                                        <div id="savedChiefComplaints"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <form id="chiefComplaintForm" method="post">
                            <div id="popupContainer" class="popup-container"></div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                       
                                        <div id="chiefComplaintsContainer">
                                            <!-- Chief Complaints will be dynamically added here -->
                                            <table class="table table-borderless" id="chiefComplaintsTable">
                                                <thead>
                                                    <tr>
                                                        <!-- Add table headers here if needed -->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr id="chiefComplaintRow1">
                                                        <!-- Add initial row content here if needed -->
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-info" onclick="addChiefComplaint()">
                                            <i class="fa fa-plus-square" aria-hidden="true"></i>  Add chief complaint
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="editChiefComplaint()">
                                            <i class="fa fa-edit" aria-hidden="true"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="ViewChiefComplaint()">
                                            <i class="fa fa-eye" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                         
                        </form>
                        
                     
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Add  Consultation Notes</div>
                    <div class="card-body">                     
                    <form id="addConsultationForm"  action="{% url 'kahamahmis:save_remotesconsultation_notes' patient.id visit.id %}" method="post">       
                            <div class="container-fluid">                            
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="row">
                                                <div class="col-md-12">
                                                 
                                                </div>                                           
                                            </div>
                                        <div class="row">                                            
                                                <div class="col-md-12">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Primary Physical Examination</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- Airway -->
                                                            <div class="form-group">
                                                                <label for="airway">Airway:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="airway" name="airway" onchange="toggleAirwayFields()">
                                                                    <option value=""></option>
                                                                    <option value="Patent" {% if primary_examination.patent_airway == 'Patent' %} selected {% endif %}>Patent</option>
                                                                    <option value="Not Patent" {% if primary_examination.patent_airway == 'Not Patent' %} selected {% endif %}>Not Patent</option>
                                                                </select>
                                                            </div>
                                                            <div id="explanationField" {% if primary_examination.airway == 'Not Patent' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <div class="form-group">
                                                                    <label for="explanation">Explain:</label>
                                                                    <textarea class="form-control" id="explanation" name="explanation" rows="3">{{ primary_examination.notpatient_explanation }}</textarea>
                                                                </div>
                                                            </div>
                                                            <input type="hidden" name="patient_id" id="patient_id" value="{{ patient.id }}">
                                                            <input type="hidden" class="form-control" id="visit_id" name="visit_id" value="{{ visit.id }}">
                                                            <!-- Breathing -->
                                                            <div class="form-group">
                                                                <label for="breathing">Breathing:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="breathing" name="breathing" onchange="toggleBreathingFields()">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if primary_examination.breathing == 'Normal' %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if primary_examination.breathing == 'Abnormal' %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <!-- Normal Breathing Options (hidden by default) -->
                                                            <div class="form-group" id="normalBreathingOptions" {% if primary_examination.breathing == 'Normal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="normalBreathing">Normal Breathing:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="normalBreathing" name="normalBreathing[]" multiple>
                                                                    <option value="">All</option>
                                                                    <option value="Trachea Central" {% if 'Trachea Central' in primary_examination.normal_breathing %} selected {% endif %}>Trachea Central</option>
                                                                    <option value="Normal Respiratory Effort" {% if 'Normal Respiratory Effort' in primary_examination.normal_breathing %} selected {% endif %}>Normal Respiratory Effort</option>
                                                                    <option value="Normal Chest Symmetry and Movement" {% if 'Normal Chest Symmetry and Movement' in primary_examination.normal_breathing %} selected {% endif %}>Normal Chest Symmetry and Movement</option>
                                                                    <option value="No Asymmetry" {% if 'No Asymmetry' in primary_examination.normal_breathing %} selected {% endif %}>No Asymmetry</option>
                                                                    <option value="Bilateral Trachea" {% if 'Bilateral Trachea' in primary_examination.normal_breathing %} selected {% endif %}>Bilateral Trachea</option>
                                                                    <option value="Resonant Percussion Note" {% if 'Resonant Percussion Note' in primary_examination.normal_breathing %} selected {% endif %}>Resonant Percussion Note</option>
                                                                    <option value="No Cyanosis" {% if 'No Cyanosis' in primary_examination.normal_breathing %} selected {% endif %}>No Cyanosis</option>
                                                                    <option value="Normal Respiratory Rate" {% if 'Normal Respiratory Rate' in primary_examination.normal_breathing %} selected {% endif %}>Normal Respiratory Rate</option>
                                                                </select>
                                                            </div>
                                                            <!-- Abnormal Breathing Field (hidden by default) -->
                                                            <div class="form-group" id="abnormalBreathingField" {% if primary_examination.breathing == 'Abnormal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="abnormalBreathing">Abnormal Breathing Details:</label>
                                                                <input type="text" class="form-control" id="abnormalBreathing" name="abnormalBreathing" placeholder="Enter details..." value="{{ primary_examination.abnormal_breathing }}">
                                                            </div>
                                                            
                                                            <!-- Circulating -->
                                                            <div class="form-group">
                                                                <label for="circulating">Circulating:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="circulating" name="circulating" onchange="toggleCirculatingFields()">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if primary_examination.circulating == 'Normal' %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if primary_examination.circulating == 'Abnormal' %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <!-- Normal Circulating Options (hidden by default) -->
                                                            <div class="form-group" id="normalCirculatingOptions" {% if primary_examination.circulating == 'Normal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="normalCirculating">Normal Circulating:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="normalCirculating" name="normalCirculating[]" multiple>
                                                                    <option value="">All</option>
                                                                    <option value="Capillary Refills" {% if 'Capillary Refills' in primary_examination.normal_circulating %} selected {% endif %}>Capillary Refills</option>
                                                                    <option value="No External Bleeding" {% if 'No External Bleeding' in primary_examination.normal_circulating %} selected {% endif %}>No External Bleeding</option>
                                                                    <option value="Normal Pulse" {% if 'Normal Pulse' in primary_examination.normal_circulating %} selected {% endif %}>Normal Pulse</option>
                                                                    <option value="Normal Blood Pressure" {% if 'Normal Blood Pressure' in primary_examination.normal_circulating %} selected {% endif %}>Normal Blood Pressure</option>
                                                                </select>
                                                            </div>
                                                            <!-- Abnormal Circulating Field (hidden by default) -->
                                                            <div class="form-group" id="abnormalCirculatingField" {% if primary_examination.circulating == 'Abnormal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="abnormalCirculating">Abnormal Circulating Details:</label>
                                                                <input type="text" class="form-control" id="abnormalCirculating" name="abnormalCirculating" placeholder="Enter details..." value="{{ primary_examination.abnormal_circulating }}">
                                                            </div>                                                         
                                                            <div class="card">
                                                                <div class="card-header">
                                                                    <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Disabilities</h6>
                                                                </div>
                                                                <div class="card-body">
                                                                    <!-- GCS Field -->
                                                                    <div class="form-group" id="gcsField">
                                                                        <label for="gcss">Glasgow Coma Scale</label>
                                                                        <select  class="form-control select2bs4" style="width: 100%;" id="gcss" name="gcs">
                                                                            <option value=""></option>
                                                                            {% for score in range_15 %}                                                                           
                                                                            <option value="{{ score }}" {% if score == primary_examination.gcs %} selected {% endif %}>{{ score }}</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>                                                                    
                                                                    <!-- RBG Field -->
                                                                    <div class="form-group" id="rbgField">
                                                                        <label for="rbg">RBG Value:</label>
                                                                        <input type="text" class="form-control" id="rbg" name="rbg" placeholder="Enter RBG Value" value="{{ primary_examination.rbg }}">
                                                                    </div>                                                                    
                                                                    <!-- Pupil Field -->
                                                                    <div class="form-group" id="pupilField">
                                                                        <label for="pupil">Pupil Size:</label>
                                                                        <select class="form-control select2bs4" style="width: 100%;" id="pupil" name="pupil">
                                                                            <option value=""></option>
                                                                            <option value="Normal" {% if primary_examination.pupil == "Normal" %} selected {% endif %}>Normal</option>
                                                                            <option value="Dilated" {% if primary_examination.pupil == "Dilated" %} selected {% endif %}>Dilated</option>
                                                                            <option value="Constricted" {% if primary_examination.pupil == "Constricted" %} selected {% endif %}>Constricted</option>
                                                                        </select>
                                                                    </div>                                                                    
                                                                    <!-- Pain Score Field -->
                                                                    <div class="form-group" id="painScoreField">
                                                                        <label for="painScore">Pain Score:</label>
                                                                        <select class="form-control select2bs4" style="width: 100%;" id="painScore" name="painScore">
                                                                            <option value=""></option>
                                                                            <option value="0" {% if primary_examination.pain_score == "0" %} selected {% endif %}>0 - No Pain</option>
                                                                            <option value="3-6" {% if primary_examination.pain_score == "3-6" %} selected {% endif %}>3-6 - Mild Pain</option>
                                                                            <option value="5-7" {% if primary_examination.pain_score == "5-7" %} selected {% endif %}>5-7 - Moderate Pain</option>
                                                                            <option value="7-9" {% if primary_examination.pain_score == "7-9" %} selected {% endif %}>7-9 - Severe Pain</option>
                                                                            <option value="8-10" {% if primary_examination.pain_score == "8-10" %} selected {% endif %}>8-10 - Very Severe Pain</option>
                                                                            <option value="10" {% if primary_examination.pain_score == "10" %} selected {% endif %}>10 - Worst Pain</option>
                                                                        </select>
                                                                    </div>                                                                    
                                                                    <!-- AVPU Scale -->
                                                                    <div class="form-group" id="avpuField">
                                                                        <label for="avpus">AVPU Scale</label>
                                                                        <select class="form-control select2bs4" style="width: 100%;" id="avpus" name="avpu">
                                                                            <option value=""></option>
                                                                            <option value="Alert" {% if 'Alert' == primary_examination.avpu %} selected {% endif %}>Alert</option>
                                                                            <option value="Verbal" {% if 'Verbal' == primary_examination.avpu %} selected {% endif %}>Verbal</option>
                                                                            <option value="Pain" {% if 'Pain' == primary_examination.avpu %} selected {% endif %}>Pain</option>
                                                                            <option value="Unresponsive" {% if 'Unresponsive' == primary_examination.avpu %} selected {% endif %}>Unresponsive</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>                                                           
                                                            <!-- Exposure -->
                                                            <div class="form-group">
                                                                <label for="exposure">Exposure:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="exposure" name="exposure" onchange="toggleExposureFields()">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if primary_examination.exposure == "Normal" %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if primary_examination.exposure == "Abnormal" %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>                                                            
                                                            <!-- Temperature Field (hidden by default) -->
                                                            <div class="form-group" id="temperatureField" {% if primary_examination.exposure == 'Normal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="normal_exposure">Normal Exposure:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="normal_exposure" name="normal_exposure[]" multiple>
                                                                    <option value="">All</option>
                                                                    <option value="Temperature" {% if "Temperature" in primary_examination.normal_exposure %} selected {% endif %}>Temperature</option>
                                                                    <option value="No external bleeding" {% if "No external bleeding" in primary_examination.normal_exposure %} selected {% endif %}>No external bleeding</option>
                                                                    <option value="No external wound" {% if "No external wound" in primary_examination.normal_exposure %} selected {% endif %}>No external wound</option>
                                                                    <option value="No hematoma" {% if "No hematoma" in primary_examination.normal_exposure %} selected {% endif %}>No hematoma</option>
                                                                    <option value="No rashes" {% if "No rashes" in primary_examination.normal_exposure %} selected {% endif %}>No rashes</option>
                                                                    <option value="No foreign body" {% if "No foreign body" in primary_examination.normal_exposure %} selected {% endif %}>No foreign body</option>
                                                                </select>
                                                            </div>                                                           
                                                            <!-- Other Abnormalities Field (hidden by default) -->
                                                            <div class="form-group" id="abnormalitiesField" {% if primary_examination.exposure == 'Abnormal' %} style="display: block;" {% else %} style="display: none;" {% endif %}>
                                                                <label for="abnormalities">Fill Abnormalities:</label>
                                                                <input type="text" class="form-control" id="abnormalities" name="abnormalities" placeholder="Enter details..." value="{{ primary_examination.abnormal_exposure }}">
                                                            </div>
                                                        </div>                                                       
                                                    </div>
                                                </div>                                        
                                        </div>                                          
                                     <!-- Secondary Survey -->                                    
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Secondary physical examination</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- Additional fields for secondary survey -->
                                                            <div class="form-group">
                                                                <label for="heent">HEENT:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="heent" name="heent">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.heent %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.heent %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="cns">CNS:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="cns" name="cns">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.cns %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.cns %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="cvs">CVS:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="cvs" name="cvs">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.cvs %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.cvs %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="rs">RS:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="rs" name="rs">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.rs %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.rs %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="pa">PA:</label>
                                                                <select class="form-control select2bs4" style="width: 100%;" id="pa" name="pa">
                                                                    <option value=""></option>
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.pa %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.pa %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="gu">GU:</label>                                                                
                                                                <select class="form-control select2bs4" style="width: 100%;" id="gu" name="gu">  
                                                                    <option value=""></option>                                                               
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.gu %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.gu %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="mss">MSS:</label>                                                                
                                                                <select class="form-control select2bs4" style="width: 100%;" id="mss" name="mss">     
                                                                    <option value=""></option>                                                               
                                                                    <option value="Normal" {% if "Normal" == secondary_examination.mss %} selected {% endif %}>Normal</option>
                                                                    <option value="Abnormal" {% if "Abnormal" == secondary_examination.mss %} selected {% endif %}>Abnormal</option>
                                                                </select>
                                                            </div>
                                                        </div>                                                      
                                                    </div>
                                                </div>                                                
                                            </div>                                            
                                        </div>
                                 
                                        <div class="col-md-6">
                                            <label for="physical_examination">Patient Health Records</label>
                                            <div class="row">
                                                <div class="col-md">
                                                    <!-- Health Condition -->
                                                  {% if health_conditions %}
                                                  <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Chronic Illness Conditions</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="table-responsive">
                                                            <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="health_conditions_table" style="width:100%">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Chronic Illness</th>
                                                                        <th>Details of Chronic Illness</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for health_condition in health_conditions %}
                                                                    <tr>
                                                                        <td>{{ health_condition.health_condition }}</td>
                                                                        <td>{{ health_condition.health_condition_notes }}</td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                  {% endif %}
                                        
                                                    <!-- Medication Allergies -->
                                                        {% if allergies  %}
                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Medication Allergies</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="table-responsive">
                                                                    <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="medication_allergies_table" style="width:100%">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Drug Name</th>
                                                                                <th>details</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {% for allergy in allergies %}
                                                                            <tr>
                                                                                <td>{{ allergy.medicine_name }}</td>
                                                                                <td>{{ allergy.reaction }}</td>
                                                                            </tr>
                                                                            {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                        
                                                {% if family_history %}
                                                             <!-- Family Medical History -->
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Family Medical History</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="family_medical_history_table" style="width:100%">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Condition</th>
                                                                            <th>Relationship</th>
                                                                            <th>Comments</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for history in family_history %}
                                                                        <tr>
                                                                            <td>{{ history.condition }}</td>
                                                                            <td>{{ history.relationship }}</td>
                                                                            <td>{{ history.comments }}</td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        {% endif %}

                                                {% if patient_surgeries %}
                                                 <!-- Patient Surgery Information-->
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Patient Surgery Information</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="family_medical_history_table" style="width:100%">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Surgery Name</th>
                                                                            <th>Surgery Details</th>                                                                         
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for surgery in patient_surgeries %}
                                                                        <tr>
                                                                            <td>{{ surgery.surgery_name }}</td>
                                                                            <td>{{ surgery.surgery_date }}</td>                                                                            
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        {% endif %}
                                        
                                                        {% if "yes" in behaviors.weekly_exercise_frequency or "yes" in behaviors.alcohol_consumption or "yes" in behaviors.smoking or "yes" in behaviors.healthy_diet or "yes" in behaviors.stress_management or "yes" in behaviors.sufficient_sleep %}
                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h6 class="header-title text-center mt-0 mb-1 text-uppercase">Lifestyle Behaviors</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <ul class="list-group">
                                                                    {% if behaviors.weekly_exercise_frequency == "yes" %}
                                                                    <li class="list-group-item">Weekly Exercise Frequency</li>
                                                                    {% endif %}
                                                                    {% if behaviors.smoking == "yes" %}
                                                                    <li class="list-group-item">Smoking</li>
                                                                    {% endif %}
                                                                    {% if behaviors.alcohol_consumption == "yes" %}
                                                                    <li class="list-group-item">Alcohol Consumption</li>
                                                                    {% endif %}
                                                                    {% if behaviors.healthy_diet == "yes" %}
                                                                    <li class="list-group-item">Healthy Diet</li>
                                                                    {% endif %}
                                                                    {% if behaviors.stress_management == "yes" %}
                                                                    <li class="list-group-item">Stress Management</li>
                                                                    {% endif %}
                                                                    {% if behaviors.sufficient_sleep == "yes" %}
                                                                    <li class="list-group-item">Sufficient Sleep</li>
                                                                    {% endif %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                     </div>                  
                                   
                       
                                        {% csrf_token %} 
                                        <div class="form-group">
                                            <label for="nature_of_current_illness{{ consultation_note.id }}">Nature of current illness:</label>
                                            <select class="form-control select2bs4" style="width: 100%;" id="nature_of_current_illness{{ consultation_note.id }}" name="nature_of_current_illness">
                                                <option value="Non-occupational" {% if consultation_note.nature_of_current_illness == 'Non-occupational' %} selected {% endif %}>Non-occupational</option>
                                                <option value="Occupational" {% if consultation_note.nature_of_current_illness == 'Occupational' %} selected {% endif %}>Occupational</option>
                                                <option value="Unknown" {% if consultation_note.nature_of_current_illness == 'Unknown' %} selected {% endif %}>Unknown</option>
                                            </select>
                                        </div>   
                                    <div class="form-group">                                        
                                          <!-- History of presenting illness -->
                                          <div class="form-group">
                                            <label for="history_of_presenting_illness">History of Presenting Illness:</label>
                                            <textarea class="form-control" rows="10" id="history_of_presenting_illness" name="history_of_presenting_illness" col="25">{{ consultation_note.history_of_presenting_illness }}</textarea>
                                        </div>  
                                    </div>
                                </div>                    
                                        <!-- Type of illness -->
                                    <div class="form-group">
                                        <label for="type_of_illness{{ consultation_note.id }}">Type of illness:</label>
                                        <select class="form-control select2bs4" style="width: 100%;" id="type_of_illness{{ consultation_note.id }}" name="type_of_illness">
                                            <option value="Medical" {% if consultation_note.type_of_illness == 'Medical' %} selected {% endif %}>Medical</option>
                                            <option value="Injury" {% if consultation_note.type_of_illness == 'Injury' %} selected {% endif %}>Injury</option>
                                            <option value="Surgical-non traumatic" {% if consultation_note.type_of_illness == 'Surgical-non traumatic' %} selected {% endif %}>Surgical-non traumatic</option>
                                        </select>                        
                                    </div>
                                    <!-- Nature of current illness -->
                                           <!-- Pathology -->
                                           <div class="form-group">
                                            <label for="pathology{{ consultation_note.id }}">Pathology:</label>
                                            <select class="form-control select2bs4" style="width: 100%;" id="pathology{{ consultation_note.id }}" name="pathology[]" required multiple>
                                                {% for record in pathology_records %}
                                                <option value="{{ record.id }}" {% if record in consultation_note.pathology.all %} selected {% endif %}>{{ record.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>                                          
                                    <!-- Provisional diagnosis -->
                                    <div class=" form-group">
                                        <label for="provisional_diagnosis{{ consultation_note.id }}">Provisional Diagnosis:</label>
                                        <select class="form-control select2bs4" style="width: 100%;" id="provisional_diagnosis{{ consultation_note.id }}" name="provisional_diagnosis[]" required multiple>
                                            {% for diagnosis in provisional_diagnoses %}
                                                <option value="{{ diagnosis.id }}" {% if diagnosis.id in provisional_diagnosis_ids %} selected {% endif %}>{{ diagnosis }}</option>
                                            {% endfor %}
                                        </select>                       
                                   
                                   <!-- Doctor plan -->
                                    <div class="form-group">
                                        <label for="doctor_plan">Doctor Plan:</label>
                                        <select class="form-control select2bs4" style="width: 100%;" id="doctor_plan" name="doctor_plan" required>
                                            <option value="">Select Doctor Plan</option>
                                            <option value="Prescription" {% if consultation_note.doctor_plan == 'Prescription' %} selected {% endif %}>Prescription</option>
                                            <option value="Laboratory" {% if consultation_note.doctor_plan == 'Laboratory' %} selected {% endif %}>Laboratory</option>                                          
                                            <option value="Procedure" {% if consultation_note.doctor_plan == 'Procedure' %} selected {% endif %}>Procedure</option>
                                            <option value="Observation" {% if consultation_note.doctor_plan == 'Observation' %} selected {% endif %}>Observation</option>
                                            <option value="Referral" {% if consultation_note.doctor_plan == 'Referral' %} selected {% endif %}>Referral</option>
                                            <option value="Counselling" {% if consultation_note.doctor_plan == 'Counselling' %} selected {% endif %}>Counselling</option>
                                            <option value="Discharge" {% if consultation_note.doctor_plan == 'Discharge' %} selected {% endif %}>Discharge</option>
                                        </select>
                                    </div>

                                    <!-- Hidden buttons for each doctor plan -->
                                    <button type="button" class="btn btn-primary referral-button" {% if consultation_note.doctor_plan == 'Referral' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousReferralModal">View Previous Referral </button>
                                    <button type="button" class="btn btn-primary counselling-button" {% if consultation_note.doctor_plan == 'Counselling' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousCounsellingModal">View Previous Counselling </button>
                                    <!-- Add similar hidden buttons for other doctor plans -->
                                    <button type="button" class="btn btn-primary prescription-button" {% if consultation_note.doctor_plan == 'Prescription' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousPrescriptionModal">View Previous Prescription </button>
                                    <button type="button" class="btn btn-primary laboratory-button" {% if consultation_note.doctor_plan == 'Laboratory' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousLaboratoryModal">View Previous Laboratory </button>
                                    <button type="button" class="btn btn-primary procedure-button" {% if consultation_note.doctor_plan == 'Procedure' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousProceduresModal">View Previous Procedures</button>
                                    <button type="button" class="btn btn-primary observation-button" {% if consultation_note.doctor_plan == 'Observation' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousObservationModal">View Previous Observation </button>
                                    <button type="button" class="btn btn-primary discharge-button" {% if consultation_note.doctor_plan == 'Discharge' %} style="display: block;" {% else %} style="display: none;" {% endif %} data-toggle="modal" data-target="#previousDischargeModal">View Previous Discharge </button>
                            </div>
                            <div class="card-footer">
                                {% if messages %}
                                <div class="row">
                                    <div class="col-12">
                                        {% for message in messages %}
                                        {% if message.tags == 'error' %}
                                        <div class="alert alert-danger">{{ message }}</div>
                                        {% elif message.tags == 'success' %}
                                        <div class="alert alert-primary">{{ message }}</div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <!-- Submit button -->
                            <div class="form-row">
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary btn-block">Save & Continue</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>


<div class="modal fade" id="previousProceduresModal" tabindex="-1" role="dialog" aria-labelledby="previousProceduresModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousProceduresModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }} Previous Procedures</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="example">
                        <thead>
                            <tr>                            
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>
                                <th>Procedure Name</th>
                                <th>Description</th>                           
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous procedures and populate the table -->
                            {% for procedure in previous_procedures %}
                            <tr>                           
                                <td>{{ procedure.created_at.date|date:"d/m/Y"  }}</td>
                                <td>{{ procedure.created_at.time }}</td>
                                <td>{{ procedure.created_at|date:"l" }}</td>
                                <td>{{ procedure.name }}</td>
                                <td style="word-wrap: break-word;">{{ procedure.description }}</td>
                                 </tr>                            
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Referral Modal -->
<div class="modal fade" id="previousReferralModal" tabindex="-1" aria-labelledby="previousReferralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousReferralModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Previous Referral Records</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display referral records -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="example1">
                        <thead>
                            <tr>
                                <!-- Table headers -->
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>                                                  
                                <th>Data Recorder</th>
                                <th>Source Location</th>
                                <th>Destination Location</th>                        
                                <th>Notes</th>
                                <th>Nature of Referral</th>
                                <th>Transport Model</th>
                                <th>Status</th>
                                <!-- Add more columns for referral data as needed -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous referral records -->
                            {% for referral in previous_referrals %}
                                <tr>
                                    <!-- Display data for each field -->
                                    <td>{{ referral.created_at.date|date:"d/m/Y"  }}</td>
                                    <td>{{ referral.created_at.time }}</td>
                                    <td>{{ referral.created_at|date:"l" }}</td>                                                             
                                    <td>{{ referral.data_recorder }}</td>
                                    <td>{{ referral.source_location }}</td>
                                    <td>{{ referral.destination_location }}</td>                                  
                                    <td>{{ referral.notes|safe }}</td>
                                    <td>{{ referral.nature_of_referral }}</td>
                                    <td>{{ referral.transport_model }}</td>
                                    <td>{{ referral.status }}</td>
                                    <!-- Add more columns for referral data as needed -->
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Previous Laboratory Modal -->
<div class="modal fade" id="previousLaboratoryModal" tabindex="-1" aria-labelledby="previousLaboratoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousLaboratoryModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Previous Laboratory Orders</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display laboratory orders -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-bordered table-striped table-sm display" id="example2">
                        <thead>
                            <tr>
                                <!-- Table headers -->
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>                              
                               <th>Data Recorder</th>
                                <th>Service Name</th>
                                <th>Test Result</th>                    
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous laboratory orders -->
                            {% for lab_order in previous_lab_orders %}
                                <tr>
                                    <!-- Display laboratory order data in table rows -->
                                    <td>{{ lab_order.created_at.date|date:"d/m/Y"  }}</td>
                                    <td>{{ lab_order.created_at.time }}</td>
                                    <td>{{ lab_order.created_at|date:"l" }}</td>
                                    <td>{{ lab_order.data_recorder }}</td>
                                    <td>{{ lab_order.name }}</td>
                                    <td>{{ lab_order.result }}</td>                          
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Previous Counseling Modal -->
<div class="modal fade" id="previousCounsellingModal" tabindex="-1" aria-labelledby="previousCounsellingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousCounsellingModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Previous Counseling Notes</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display counseling notes -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-bordered table-striped table-sm display" id="example3">
                        <thead>
                            <tr>
                                <!-- Table headers -->
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>
                                <th>Data Recorder</th>
                                <th>Counseling Notes</th>
                               </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous counseling notes -->
                            {% for counseling in previous_counselings %}
                                <tr>
                                    <!-- Display counseling note data in table rows -->
                                    <td>{{ counseling.created_at|date:"d/m/Y" }}</td>
                                    <td>{{ counseling.created_at.time }}</td>
                                    <td>{{ counseling.created_at|date:"l" }}</td>
                                    <td>{{ counseling.data_recorder }}</td>
                                    <td>{{ counseling.counselling_notes|safe }}</td>
                                     </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Previous Observation Modal -->
<div class="modal fade" id="previousObservationModal" tabindex="-1" aria-labelledby="previousObservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousObservationModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Previous Observation Records</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display observation records -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-bordered table-striped table-sm display" id="example4">
                        <thead>
                            <tr>
                                <!-- Table headers -->                  
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>
                                <th>Data Recorder</th>
                                <th>Observation Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous observation records -->
                            {% for observation in previous_observations %}
                                <tr>
                                    <!-- Display observation record data in table rows -->
                                    <td>{{ observation.created_at.date|date:"d/m/Y"  }}</td>
                                    <td>{{ observation.created_at.time }}</td>
                                    <td>{{ observation.created_at|date:"l" }}</td>
                                    <td>{{ observation.data_recorder }}</td>
                                    <td>{{ observation.observation_notes|safe }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Previous Discharge Modal -->
<div class="modal fade" id="previousDischargeModal" tabindex="-1" aria-labelledby="previousDischargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousDischargeModalLabel">{{ patient.first_name }} {{ patient.middle_name }} {{ patient.last_name }}  Previous Discharge Records</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display discharge records -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-bordered table-striped table-sm display" id="example5">
                        <thead>
                            <tr>
                                <!-- Table headers -->
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>
                                <th>Data Recorder</th>
                                <th>Discharge Condition</th>
                                <th>Discharge Notes</th>                          
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous discharge records -->
                            {% for discharge in previous_discharges %}
                                <tr>
                                    <!-- Display discharge record data in table rows -->
                                    <td>{{ discharge.discharge_date.date|date:"d/m/Y"  }}</td>
                                    <td>{{ discharge.discharge_date.time }}</td>
                                    <td>{{ discharge.discharge_date|date:"l" }}</td>
                                    <td>{{ discharge.data_recorder }}</td>
                                    <td>{{ discharge.discharge_condition }}</td>
                                    <td>{{ discharge.discharge_notes|safe }}</td>                            
                                    <!-- Add more fields as needed -->
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Modal -->
<div class="modal fade" id="previousPrescriptionModal" tabindex="-1" aria-labelledby="previousPrescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previousPrescriptionModalLabel">Previous Prescription Records</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Table to display prescription records -->
                <div class="table-responsive">
                    <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="example6">
                        <thead>
                            <tr>
                                <!-- Table headers -->
                                <th>Date</th>
                                <th>Time</th>
                                <th>Day</th>                               
                                <th>Entered By</th>
                                <th>Drug name</th>
                                 <th>Dose</th>
                                <th>Frequency</th>
                                <th>Duration</th>
                                <th>Quantity Used</th>
                                <th>Verified</th>
                                <th>Issued</th>
                                <th>Status</th>
                                <th>Total Price</th>
                                <!-- Add more columns as needed -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through previous prescription records -->
                            {% for prescription in previous_prescriptions %}
                                <tr>
                                    <!-- Display data for each field -->
                                    <td>{{ prescription.created_at.date|date:"d/m/Y"  }}</td>
                                    <td>{{ prescription.created_at.time }}</td>
                                    <td>{{ prescription.created_at|date:"l" }}</td>                                  
                                    <td>{{ prescription.entered_by }}</td>
                                    <td>{{ prescription.medicine }}</td>                              
                                    <td>{{ prescription.dose }}</td>
                                    <td>{{ prescription.frequency }}</td>
                                    <td>{{ prescription.duration }}</td>
                                    <td>{{ prescription.quantity_used }}</td>
                                    <td>{{ prescription.verified }}</td>
                                    <td>{{ prescription.issued }}</td>
                                    <td>{{ prescription.status }}</td>
                                    <td>{{ prescription.total_price }}</td>
                                    <!-- Add more fields as needed -->
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- Modal -->
<div class="modal fade" id="addPatientVitalModal" tabindex="-1" role="dialog" aria-labelledby="addPatientVitalModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPatientVitalModalLabel">Add Patient Vital</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="card">
            <div class="card-header">Add Patient Vital</div>
            <div class="card-body">
                <form method="post" id="AddPatientVitalForm">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="respiratory_rate">Respiratory Rate (breaths per minute)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="respiratoryRate" name="respiratory_rate" required>
                                <option value=""></option>
                                {% for rate in range_15 %}
                                    <option value="{{ rate }}">{{ rate }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="patient_id" id="patient_id" value="{{ patient.id }}">
                        <input type="hidden" name="vital_id" id="vital_id" value="">
                        <input type="hidden" class="form-control" id="visit_id" name="visit_id" value="{{ visit.id }}">
                        <div class="form-group col-md-6">
                            <label for="pulse_rate">Pulse Rate (beats per minute)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="pulseRate" name="pulse_rate" required>
                                <option value=""></option>
                                {% for rate in range_301 %}
                                    <option value="{{ rate }}">{{ rate }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="sbp">Systolic Blood Pressure (mmHg)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="sbp" name="sbp" required>
                                <option value=""></option>
                                {% for value in range_301 %}
                                    <option value="{{ value }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="dbp">Diastolic Blood Pressure (mmHg)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="dbp" name="dbp" required>
                                <option value=""></option>
                                {% for value in range_301 %}
                                    <option value="{{ value }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="avpu">AVPU Scale</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="avpu" name="avpu" required>
                                <option value=""></option>
                                <option value="Alert">Alert</option>
                                <option value="Verbal">Verbal</option>
                                <option value="Pain">Pain</option>
                                <option value="Unresponsive">Unresponsive</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="spo2">SPO2 (%)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="spo2" name="spo2" required>
                                <option value=""></option>
                                {% for percentage in range_101 %}
                                    <option value="{{ percentage }}">{{ percentage }}%</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="temperature">Temperature (Â°C)</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="temperature" name="temperature" >
                                <option value=""></option>
                                {% for temp in temps %}
                                    <option value="{{ temp }}">{{ temp }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="gcs">Glasgow Coma Scale</label>
                            <select class="form-control select2bs4" style="width: 100%;" id="gcs" name="gcs" required>
                                <option value=""></option>
                                {% for score in range_15  %}
                                    <option value="{{ score }}">{{ score }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>                 
                 
                    <div class="form-row">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary btn-block" onclick="addRemotePatientVital()">Add new patient vital</button>
                        </div>
                    </div>
                
                </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    
      <script>
        // Handle form submission using AJAX
        function addRemotePatientVital() {
            $.ajax({
                type: 'POST',
                url: '{% url "kahamahmis:save_remotepatient_vital" %}',  // Replace with your URL
                data: $('#AddPatientVitalForm').serialize(),
                success: function (data) {
                    if (data.status === 'success') {
                        $('#addPatientVitalModal').modal('hide');
                            location.reload(true)
                        // Refresh the inventory vital list or perform any other actions
                    } else {
                        // Handle other status cases if needed
                        alert(data.message);
                    }
                },
                error: function (error) {
                    alert(error);
                    // Handle errors if necessary
                }
            });
        }
    </script>

    <script>
        function toggleAirwayFields() {
            var explanationField = document.getElementById('explanationField');
            if (document.getElementById('airway').value === 'Not Patent') {
                explanationField.style.display = 'block';
            } else {
                explanationField.style.display = 'none';
            }
        }
    
        function toggleBreathingFields() {
            var normalBreathingOptions = document.getElementById('normalBreathingOptions');
            var abnormalBreathingField = document.getElementById('abnormalBreathingField');
            var normalBreathingSelect = document.getElementById('normalBreathing');
        
            if (document.getElementById('breathing').value === 'Normal') {
                normalBreathingOptions.style.display = 'block';
                abnormalBreathingField.style.display = 'none';
        
                // Select all options in the "Normal Breathing" select
                for (var i = 0; i < normalBreathingSelect.options.length; i++) {
                    normalBreathingSelect.options[i].selected = true;
                }
            } else {
                normalBreathingOptions.style.display = 'none';
                abnormalBreathingField.style.display = 'block';
        
                // Unselect all options in the "Normal Breathing" select
                for (var i = 0; i < normalBreathingSelect.options.length; i++) {
                    normalBreathingSelect.options[i].selected = false;
                }
            }
        }
    
        function toggleCirculatingFields() {
            var normalCirculatingOptions = document.getElementById('normalCirculatingOptions');
            var abnormalCirculatingField = document.getElementById('abnormalCirculatingField');
            var normalCirculatingSelect = document.getElementById('normalCirculating');
        
            if (document.getElementById('circulating').value === 'Normal') {
                normalCirculatingOptions.style.display = 'block';
                abnormalCirculatingField.style.display = 'none';
        
                // Select all options in the "Normal Circulating" select
                for (var i = 0; i < normalCirculatingSelect.options.length; i++) {
                    normalCirculatingSelect.options[i].selected = true;
                }
            } else {
                normalCirculatingOptions.style.display = 'none';
                abnormalCirculatingField.style.display = 'block';
            }
        }
    
       
    
        function toggleExposureFields() {
            var exposure = document.getElementById('exposure').value;
            var temperatureField = document.getElementById('temperatureField');
            var abnormalitiesField = document.getElementById('abnormalitiesField');
            var temperaturesSelect = document.getElementById('normal_exposure');
        
            if (exposure === 'Normal') {
                temperatureField.style.display = 'block';
                abnormalitiesField.style.display = 'none';
        
                // Select all options in the "Normal Exposure" select
                for (var i = 0; i < temperaturesSelect.options.length; i++) {
                    temperaturesSelect.options[i].selected = true;
                }
            } else {
                temperatureField.style.display = 'none';
                abnormalitiesField.style.display = 'block';
        
                // Unselect all options in the "Normal Exposure" select
                for (var i = 0; i < temperaturesSelect.options.length; i++) {
                    temperaturesSelect.options[i].selected = false;
                }
            }
        }
        
    </script>
    
    <script>
                        // Function to add a new row for chief complaint
                function addChiefComplaint() {
                var container = document.getElementById('chiefComplaintsContainer');
                var rowCount = container.getElementsByTagName('tr').length + 1;

                var newRow = document.createElement('tr');
                newRow.id = 'chiefComplaintRow' + rowCount;

                newRow.innerHTML = `
                <td>
                <select class="form-control select2bs4" style="width: 100%;" name="chief_complain_name" required onchange="handleOtherOption(this.value, 'chiefComplaintRow${rowCount}')">
                {% for health_record in health_records %}
                <option value="{{health_record.id}}">{{health_record.name}}</option>
                {% endfor %}
                <option value="other">Other</option>
                </select>
                </td>
                <td>
                <input type="text" class="form-control duration-cell" name="chief_complain_duration" required placeholder ="durations">
                <input type="hidden" name="patient_id" id="patient_id" value="{{ patient.id }}">                                     
                <input type="hidden" class="form-control" id="visit_id" name="visit_id" value="{{ visit.id }}">
                </td>
                <td>
                <button type="button" class="btn btn-danger btn-sm delete-row" onclick="deleteChiefComplaint('chiefComplaintRow${rowCount}')">Delete</button>
                <button type="button" class="btn btn-success btn-sm save-row" onclick="saveChiefComplaint('chiefComplaintRow${rowCount}')">Save</button>
                </td>
                `;

                container.querySelector('tbody').appendChild(newRow);
                }




                // Function to handle editing chief complaints and toggle visibility
                function editChiefComplaint() {
                // Get the container element for chief complaints
                var chiefComplaintsContainer = document.getElementById('savedChiefComplaints');

                // Toggle visibility of the container
                if (chiefComplaintsContainer.style.display === 'none') {
                // If the container is hidden, fetch and display existing chief complaints
                fetchAndDisplayChiefComplaints();
                chiefComplaintsContainer.style.display = 'block';
                } else {
                // If the container is visible, hide it
                chiefComplaintsContainer.style.display = 'none';
                }
                }

                // Function to fetch and display existing chief complaints
                function fetchAndDisplayChiefComplaints() {
                // Get the patient ID and visit ID
                var patientId = document.getElementById('patient_id').value;
                var visitId = document.getElementById('visit_id').value;

                // Generate the URL for fetching existing chief complaints
                var url = `{% url 'kahamahmis:endpoint_to_fetch_existing_data' %}?patient_id=${patientId}&visit_id=${visitId}`;

                // Fetch existing chief complaints from the server
                fetch(url)
                .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
                })
                .then(data => {
                // Populate the form with existing chief complaints
                populateEditForm(data);
                })
                .catch(error => {
                console.error('Error fetching existing chief complaints:', error);
                });
                }

                var deleteChiefComplaintUrl = "{% url 'kahamahmis:delete_chief_complaint' chief_complaint_id=0 %}";
                // Function to populate the edit form with existing chief complaints
                function populateEditForm(existingData) {
                // Get the container where the edit form will be displayed
                var editFormContainer = document.getElementById('savedChiefComplaints');

                // Clear existing data in the container
                editFormContainer.innerHTML = '';

                // Iterate through existing chief complaints and create rows for each
                existingData.forEach(function(data) {
                // Create a row element
                var row = document.createElement('div');
                row.classList.add('row');

                // Create columns for displaying health record, duration, and delete button
                var healthRecordColumn = document.createElement('div');
                healthRecordColumn.classList.add('col');
                healthRecordColumn.textContent = data.health_record;

                var durationColumn = document.createElement('div');
                durationColumn.classList.add('col');
                durationColumn.textContent = data.duration;

                var deleteColumn = document.createElement('div');
                deleteColumn.classList.add('col');

                // Create the delete button with Font Awesome icon
                var deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.classList.add('btn', 'btn-sm', 'btn-danger','m-2');
                deleteButton.innerHTML = '<i class="fa fa-trash" aria-hidden="true"></i>';

                // Add event listener to handle deleting this chief complaint
                deleteButton.addEventListener('click', function() {
                deleteRow(data.id, row); // Pass the chief complaint ID and the row element to the delete function
                });

                // Append delete button to the delete column
                deleteColumn.appendChild(deleteButton);

                // Append columns to the row
                row.appendChild(healthRecordColumn);
                row.appendChild(durationColumn);
                row.appendChild(deleteColumn);

                // Append the row to the edit form container
                editFormContainer.appendChild(row);
                });
                }

                // Function to handle deleting a specific chief complaint row
                function deleteRow(chiefComplaintId, row) {
                // Construct the URL dynamically using the global variable
                var deleteUrl = deleteChiefComplaintUrl.replace('0', chiefComplaintId);

                // Send an AJAX request to delete the chief complaint with the given ID
                fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                'Content-Type': 'application/json',
                // Add any additional headers if needed
                },
                })
                .then(response => {
                if (!response.ok) {
                throw new Error('Failed to delete chief complaint');
                }
                // Return the response data as JSON
                return response.json();
                })
                .then(data => {
                // If the data is successfully deleted, remove the corresponding row from the edit form container
                row.remove();
                })
                .catch(error => {
                console.error('Error deleting chief complaint:', error);
                });
                }



                // Function to handle "Other" option
                function handleOtherOption(selectValue, rowId) {
                var row = document.getElementById(rowId);

                if (selectValue === 'other') {
                // Remove the previous duration input, if any
                var durationCell = row.querySelector('.duration-cell');
                if (durationCell) {
                durationCell.parentNode.removeChild(durationCell);
                }

                // Create input fields for other complaint and duration
                var otherInput = document.createElement('input');
                otherInput.type = 'text';
                otherInput.classList.add('form-control');
                otherInput.placeholder = 'Other Chief Complaint';
                otherInput.name = 'other_chief_complaint'; // Set the name attribute

                var durationInput = document.createElement('input');
                durationInput.type = 'text';
                durationInput.classList.add('form-control', 'duration-input');
                durationInput.placeholder = 'Duration (days)';
                durationInput.name = 'other_complain_duration'; // Set the name attribute

                // Get the last cell in the row to ensure proper placement
                var lastCellIndex = row.cells.length - 1;
                var lastCell = row.cells[lastCellIndex];

                // Insert new input fields to the existing row before the last cell
                lastCell.insertAdjacentHTML('beforebegin', `<td>${otherInput.outerHTML}</td>`);
                lastCell.insertAdjacentHTML('beforebegin', `<td class="duration-cell">${durationInput.outerHTML}</td>`);

                // Include the other complaint and duration inputs in the form data
                var formData = new FormData();
                formData.append('other_chief_complaint', otherInput.value);
                formData.append('other_complain_duration', durationInput.value);
                }
                }

                function fetchAndPopulateTable(patientId, visitId) {
                // Generate the URL using the URL name and parameters
                var url = `{% url 'kahamahmis:endpoint_to_fetch_existing_data' %}?patient_id=${patientId}&visit_id=${visitId}`;

                // Fetch existing data from the server
                fetch(url)
                .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
                })
                .then(data => {
                // Populate the table with existing data
                populateTable(data);
                })
                .catch(error => {
                console.error('Error fetching existing data:', error);
                });
                }


                function populateTable(savedData) {
                var savedChiefComplaints = document.getElementById('savedChiefComplaints');
                savedChiefComplaints.innerHTML = ''; // Clear existing data

                // Create table element
                var table = document.createElement('table');
                table.classList.add('list-item');

                // Create table header
                var headerRow = document.createElement('tr');
                headerRow.innerHTML = '';
                table.appendChild(headerRow);

                // Iterate through saved data and create table rows
                savedData.forEach(function(data) {
                var newRow = document.createElement('ul');
                newRow.innerHTML = `          
                <li>${data.health_record}-${data.duration}</li>       

                `;
                table.appendChild(newRow);
                });

                // Append table to the container
                savedChiefComplaints.appendChild(table);
                }

                // Function to delete a row for chief complaint
                function deleteChiefComplaint(rowId) {
                var row = document.getElementById(rowId);
                row.parentNode.removeChild(row);
                }


                // Function to fetch existing data and populate the table when the page loads or a new row is added
                document.addEventListener('DOMContentLoaded', function() {
                fetchAndPopulateTable(document.getElementById('patient_id').value, document.getElementById('visit_id').value);
                });


                function saveChiefComplaint(rowId) {
                // Get the row and initialize form data and popup container
                var row = document.getElementById(rowId);
                var formData = new FormData();
                var popupContainer = document.getElementById('popupContainer');

                // Clear previous content in the popup container
                popupContainer.innerHTML = '';

                // Get the selected chief complaint value
                var selectedValue = row.querySelector('[name="chief_complain_name"]').value;

                // Get other input fields
                var otherInput = row.querySelector('[name="other_chief_complaint"]');
                var durationInput = row.querySelector('[name="other_complain_duration"]');

                // Check if all required fields are filled
                if (!selectedValue) {
                displayPopupMessage('Please select a chief complaint.', 'alert-info');
                return; // Stop further execution if required fields are not filled
                }

                // Include other chief complaint and duration if the selected value is "other"
                if (selectedValue === 'other') {
                if (!otherInput.value || !durationInput.value) {
                displayPopupMessage('Please fill in all fields for other chief complaint.', 'alert-danger');
                return; // Stop further execution if required fields are not filled
                }
                formData.append('other_chief_complaint', otherInput.value);
                } else {
                // Include the selected chief complaint
                formData.append('chief_complain_name', selectedValue);

                // Check if duration is filled for the selected chief complaint
                if (!row.querySelector('[name="chief_complain_duration"]').value) {
                displayPopupMessage('Please fill in duration for the selected chief complaint.', 'alert-danger');
                return; // Stop further execution if required fields are not filled
                }
                formData.append('chief_complain_duration', row.querySelector('[name="chief_complain_duration"]').value);
                }

                // Include patient and visit IDs
                formData.append('patient_id', document.getElementById('patient_id').value);
                formData.append('visit_id', document.getElementById('visit_id').value);

                // Generate the URL using the URL name
                var url = "{% url 'kahamahmis:save_chief_complaint' %}";

                // Send the data to the server to save
                fetch(url, {
                method: 'POST',
                body: formData
                })
                .then(response => {
                if (!response.ok) {
                throw new Error('Network response was not ok');
                }
                return response.json();
                })
                .then(data => {
                // Display the saved data above the form
                populateTable([data]); // Add the saved data to the table

                // Fetch and populate the table with existing data only when the data is successfully saved
                fetchAndPopulateTable(document.getElementById('patient_id').value, document.getElementById('visit_id').value);
                })
                .catch(error => {
                // Check if the error message contains the specific message for duplicate ChiefComplaint
                if (error.message.includes("A ChiefComplaint with the same health record already exists for this visit")) {
                displayPopupMessage('A ChiefComplaint with the same health record already exists for this visit.', 'alert-danger');
                } else {
                // Display other error messages in the popup container
                displayPopupMessage('Error saving chief complaint: ' + error.message, 'alert-danger');
                }
                });
                }

                // Function to display popup message
                function displayPopupMessage(message, alertType) {
                var popupContainer = document.getElementById('popupContainer');
                popupContainer.innerHTML = '<div class="popup-message alert ' + alertType + '">' +
                            message +
                            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                            '<span aria-hidden="true">&times;</span></button></div>';
                }





                function ViewChiefComplaint() {
                var chiefComplaintsContainer = document.getElementById('savedChiefComplaints');
                chiefComplaintsContainer.style.display = 'block';
                fetchAndPopulateTable(
                document.getElementById('patient_id').value,
                document.getElementById('visit_id').value
                );
                }

         </script>
    {% include 'kahama_template/datatable.html' %}     
{% endblock main_content %}
